<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>LICENSE G·ªêC‚Ñ¢ ‚Ä¢ Music Room</title>
<link rel="icon" href="data:,">
<style>
:root{
  --bg:#0b0f16;--panel:#0f1420;--ink:#e9eef7;--muted:#9fb0c7;--accent:#ffd66b;--line:rgba(255,214,107,.25);
}
*{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.5 system-ui,Segoe UI,Roboto}
.wrap{max-width:980px;margin:auto;padding:16px}
h1{margin:6px 0 10px;font-size:28px}
.top{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.badge{padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:linear-gradient(180deg,#121827,#0b0f16)}
.count{display:inline-flex;align-items:center;gap:6px}
.card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px}
.grid{display:grid;gap:12px}
@media(min-width:900px){.grid{grid-template-columns:1.2fr .8fr}}
.btn{appearance:none;background:linear-gradient(180deg,#1a2030,#101522);color:var(--ink);
  border:1px solid var(--line);padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
.btn:disabled{opacity:.6;cursor:not-allowed}
.btn-pill{border-radius:999px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
hr{border:none;border-top:1px dashed var(--line);margin:10px 0}
.small{color:var(--muted);font-size:13px}

/* Player */
.player{display:grid;grid-template-columns:120px 1fr;gap:12px;align-items:center}
.cover{width:120px;height:120px;border-radius:10px;border:1px solid var(--line);background:#0b0b0f;
  display:grid;place-items:center;font-size:42px}
.title{font-weight:800}
.controls{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.icon{width:36px;height:36px;border-radius:8px;border:1px solid var(--line);
  background:linear-gradient(180deg,#1a2030,#101522);display:grid;place-items:center;cursor:pointer}
.slider{width:100%}
.time{display:flex;align-items:center;gap:8px}
.kv{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
canvas{width:100%;height:64px;background:#0a0f15;border-radius:8px;border:1px solid var(--line)}

/* Playlist */
.list{display:flex;flex-direction:column;gap:8px;max-height:360px;overflow:auto}
.item{display:flex;gap:8px;align-items:center;justify-content:space-between;border:1px solid var(--line);padding:8px;border-radius:10px;background:#0c111a}
.item b{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:58vw}

.kara{min-height:120px;border-radius:10px;border:1px solid var(--line);padding:10px;background:#0b1018}
.kline{opacity:.55}
.kline.active{opacity:1;color:var(--accent);font-weight:800}

.footer{margin:18px 0 70px;color:var(--muted);text-align:center}
</style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <h1>üé∂ LICENSE G·ªêC‚Ñ¢ ‚Ä¢ Music Room</h1>
    <span class="badge">User: <span id="meName">guest</span></span>
    <span class="badge count">üü¢ Online: <b id="online">1</b></span>
    <button class="btn btn-pill" id="btnSign">Sign in (local)</button>
  </div>

  <!-- AI + Import -->
  <div class="card">
    <div class="row">
      <label class="btn"><input id="fileIn" type="file" accept="audio/*,video/mp4" multiple hidden>‚¨ÜÔ∏è Upload audio/video</label>
      <button class="btn" id="btnRec">üéôÔ∏è Record</button>
      <button class="btn" id="btnAitext">ü§ñ AI Song ‚Ä¢ From Text</button>
      <label class="btn"><input id="imgIn" type="file" accept="image/*" hidden>ü§ñ AI Song ‚Ä¢ From Image</label>
      <button class="btn" id="btnClear">üßπ Clear list</button>
      <span class="small">* T·ªáp ƒë∆∞·ª£c ph√°t tr·ª±c ti·∫øp trong tr√¨nh duy·ªát; m·ªôt s·ªë t·ªáp l·ªõn s·∫Ω kh√¥ng l∆∞u vƒ©nh vi·ªÖn ƒë·ªÉ tr√°nh ƒë·∫ßy b·ªô nh·ªõ.</span>
    </div>
  </div>

  <div class="grid">
    <!-- Left: Player + Karaoke -->
    <div class="card">
      <div class="player">
        <div class="cover" id="cover">üéµ</div>
        <div>
          <div class="title" id="title">Ch∆∞a ch·ªçn b√†i</div>
          <div class="kv small"><span id="info">‚Äî</span></div>
          <div class="controls">
            <button class="icon" id="prev">‚èÆ</button>
            <button class="icon" id="play">‚ñ∂Ô∏è</button>
            <button class="icon" id="next">‚è≠</button>
            <button class="icon" id="loop">üîÅ</button>
            <button class="icon" id="dl" title="Download">‚¨áÔ∏è</button>
            <label class="icon" title="Volume">
              üîä <input id="vol" type="range" min="0" max="1" step="0.01" value="1" style="width:92px">
            </label>
          </div>
          <div class="time">
            <span id="cur">0:00</span>
            <input class="slider" id="seek" type="range" min="0" max="1000" value="0">
            <span id="dur">0:00</span>
          </div>
        </div>
      </div>
      <canvas id="viz" height="64"></canvas>

      <hr>
      <div class="row">
        <label class="btn"><input id="lrcIn" type="file" accept=".lrc,.txt" hidden>üìÑ Load .LRC / lyric</label>
        <button class="btn" id="btnPaste">‚úçÔ∏è D√°n lyric</button>
        <button class="btn" id="btnKClear">üßº Clear lyric</button>
      </div>
      <div id="karaoke" class="kara small">Lyric/Karaoke s·∫Ω hi·ªán ·ªü ƒë√¢y‚Ä¶</div>
    </div>

    <!-- Right: Playlist -->
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <b>Playlist</b>
        <span class="small" id="stat">0 tracks</span>
      </div>
      <div id="list" class="list"></div>
      <hr>
      <div class="small">
        Tips:
        <ul>
          <li>T·∫£i nhi·ªÅu file m·ªôt l√∫c (MP3/WAV/M4A/MP4).</li>
          <li>.LRC s·∫Ω auto ƒë·ªìng b·ªô lyric n·∫øu c√≥ timestamp.</li>
          <li>‚ÄúAI Song‚Äù demo t·∫°o giai ƒëi·ªáu t·ª´ text/·∫£nh (WebAudio, t·∫£i v·ªÅ WAV).</li>
        </ul>
      </div>
    </div>
  </div>

  <div class="footer">¬© 2025 LICENSE G·ªêC‚Ñ¢ ‚Äî Music empowers ideas.</div>
</div>

<!-- Media elements (·∫©n) -->
<audio id="audio" crossorigin="anonymous"></audio>
<video id="video" playsinline style="display:none;max-width:100%"></video>

<script>
(() => {
  // ---------- State ----------
  const $ = s => document.querySelector(s);
  const listEl = $('#list');
  const audio = $('#audio'), video = $('#video');
  const isVideo = () => cur?.type?.startsWith('video');
  let tracks = [];        // {id,name,type,size,blobUrl,ext,lyric?,cover?}
  let cur = null;         // current track
  let loop = false;
  let bc = null, me = null, onlineCount = 1;

  // ---------- Sign in (local) ----------
  function signIn(){
    const name = prompt('T√™n hi·ªÉn th·ªã?', localStorage.getItem('goc.name')||'guest') || 'guest';
    const email = prompt('Email (ƒë·ªÉ g·∫Øn ID)?', localStorage.getItem('goc.email')||'guest@example.com') || 'guest@example.com';
    localStorage.setItem('goc.name', name);
    localStorage.setItem('goc.email', email);
    $('#meName').textContent = name;
    // broadcast presence
    me = {id:Math.random().toString(36).slice(2), name};
    bc?.postMessage({type:'join', name});
    alert('ƒêƒÉng nh·∫≠p (local) th√†nh c√¥ng!');
  }
  $('#btnSign').onclick = signIn;
  $('#meName').textContent = localStorage.getItem('goc.name') || 'guest';

  // ---------- BroadcastChannel: presence ----------
  try{
    bc = new BroadcastChannel('goc-music-room');
    bc.onmessage = (e)=>{
      const m = e.data;
      if(m.type==='join' || m.type==='ping') onlineCount = Math.max(onlineCount, m.count||1);
      if(m.type==='count'){ onlineCount = m.count; $('#online').textContent = onlineCount; }
    };
    // Simple heartbeat using localStorage
    function heartbeat(){
      const key='goc-music-heart';
      localStorage.setItem(key, Date.now().toString());
      const count = performance.now()%2000<50 ? Math.floor(1+Math.random()*3) : parseInt($('#online').textContent||'1');
      bc.postMessage({type:'count', count});
      setTimeout(heartbeat,1500);
    } heartbeat();
  }catch{}

  // ---------- Utils ----------
  const fmt = s => {
    if(!isFinite(s)) return '0:00';
    const m = Math.floor(s/60), ss = Math.floor(s%60);
    return m+':'+String(ss).padStart(2,'0');
  };
  function setCover(emoji='üéµ'){ $('#cover').textContent = emoji; }
  function setTitle(t='Ch∆∞a ch·ªçn b√†i', info='‚Äî'){ $('#title').textContent=t; $('#info').textContent=info; }

  // ---------- Visualizer ----------
  const ctx = new (window.AudioContext||window.webkitAudioContext)();
  const srcNode = ctx.createMediaElementSource(audio);
  const analyser = ctx.createAnalyser(); analyser.fftSize=256;
  srcNode.connect(analyser); analyser.connect(ctx.destination);
  const viz = $('#viz'), g = viz.getContext('2d');
  function drawViz(){
    const arr = new Uint8Array(analyser.frequencyBinCount);
    analyser.getByteFrequencyData(arr);
    g.clearRect(0,0,viz.width,viz.height);
    const w = viz.width/arr.length;
    for(let i=0;i<arr.length;i++){
      const h = (arr[i]/255)*(viz.height-8);
      g.fillStyle = 'rgba(255,214,107,.85)';
      g.fillRect(i*w, viz.height-h, w-1, h);
    }
    requestAnimationFrame(drawViz);
  }
  drawViz();

  // ---------- Playlist UI ----------
  function renderList(){
    listEl.innerHTML='';
    tracks.forEach((t,i)=>{
      const row = document.createElement('div'); row.className='item';
      row.innerHTML = `<b>${i+1}. ${t.name}</b>
        <span class="row">
          <button class="btn" data-play="${t.id}">Play</button>
          <button class="btn" data-rem="${t.id}">Del</button>
        </span>`;
      listEl.appendChild(row);
    });
    $('#stat').textContent = tracks.length+' tracks';
    saveListMeta();
  }
  function saveListMeta(){
    const meta = tracks.map(t=>({id:t.id,name:t.name,type:t.type,ext:t.ext}));
    localStorage.setItem('goc.music.list', JSON.stringify(meta));
  }

  // ---------- Load from input ----------
  $('#fileIn').addEventListener('change', async (e)=>{
    const files = [...e.target.files];
    for (const f of files){
      const id = Math.random().toString(36).slice(2);
      const url = URL.createObjectURL(f);
      tracks.push({id,name:f.name,type:f.type,size:f.size,blobUrl:url,ext:f.name.split('.').pop().toLowerCase()});
    }
    renderList();
    if(!cur && tracks[0]) playById(tracks[0].id);
    e.target.value='';
  });

  // ---------- Controls ----------
  $('#play').onclick = async ()=>{
    if(isVideo()){
      if(video.paused) { await video.play(); $('#play').textContent='‚è∏Ô∏è'; ctx.resume(); }
      else { video.pause(); $('#play').textContent='‚ñ∂Ô∏è'; }
    }else{
      if(audio.paused) { await audio.play(); $('#play').textContent='‚è∏Ô∏è'; ctx.resume(); }
      else { audio.pause(); $('#play').textContent='‚ñ∂Ô∏è'; }
    }
  };
  $('#prev').onclick = ()=> step(-1);
  $('#next').onclick = ()=> step(1);
  $('#loop').onclick = ()=>{ loop=!loop; $('#loop').style.outline = loop?'2px solid var(--accent)':'none'; };
  $('#vol').oninput = e => { audio.volume = video.volume = +e.target.value; };
  $('#seek').oninput = e => {
    const frac = +e.target.value/1000;
    const dur = isVideo()? video.duration : audio.duration;
    const t = dur*frac; (isVideo()? video:audio).currentTime = t;
  };
  $('#dl').onclick = ()=>{
    if(!cur) return;
    const a = document.createElement('a');
    a.href = cur.blobUrl; a.download = cur.name; a.click();
  };
  listEl.addEventListener('click', (e)=>{
    const id = e.target.dataset.play || e.target.dataset.rem;
    if(!id) return;
    if(e.target.dataset.play) playById(id);
    if(e.target.dataset.rem){ tracks = tracks.filter(t=>t.id!==id); if(cur?.id===id) stop(); renderList(); }
  });
  $('#btnClear').onclick = ()=>{ stop(); tracks=[]; renderList(); setTitle(); setCover(); $('#karaoke').innerHTML='Lyric/Karaoke s·∫Ω hi·ªán ·ªü ƒë√¢y‚Ä¶'; };

  function step(d){
    if(!cur) return;
    const idx = tracks.findIndex(t=>t.id===cur.id);
    const j = (idx + d + tracks.length) % tracks.length;
    playById(tracks[j].id);
  }

  function stop(){
    audio.pause(); video.pause();
    audio.src=''; video.src=''; video.style.display='none';
    $('#play').textContent='‚ñ∂Ô∏è';
  }

  function playById(id){
    const t = tracks.find(x=>x.id===id); if(!t) return;
    stop(); cur = t;
    setTitle(t.name, `${t.type||''} ${(t.size?('‚Ä¢ '+(t.size/1e6).toFixed(2)+'MB'):'')}`);
    if(t.type?.startsWith('video')){ video.src=t.blobUrl; video.style.display='block'; audio.style.display='none'; video.play(); }
    else { audio.src=t.blobUrl; video.style.display='none'; audio.style.display=''; audio.play(); }
    $('#play').textContent='‚è∏Ô∏è'; ctx.resume();
    setCover(t.type?.startsWith('video')?'üé¨':'üéµ');
    // reset lyric scroll
    activeIdx=-1; renderKara();
  }

  // time / progress
  function bindTime(el){
    el.addEventListener('timeupdate', ()=>{
      $('#cur').textContent = fmt(el.currentTime);
      $('#dur').textContent = fmt(el.duration||0);
      $('#seek').value = Math.max(0, Math.min(1000, Math.floor((el.currentTime/(el.duration||1))*1000)));
      tickKara(el.currentTime);
    });
    el.addEventListener('ended', ()=>{ if(loop) playById(cur.id); else step(1); });
  }
  bindTime(audio); bindTime(video);

  // ---------- Karaoke (.lrc) ----------
  let lrc = []; // {t:number, text:string}
  let activeIdx = -1;
  function parseLRC(txt){
    const out=[];
    txt.split(/\r?\n/).forEach(line=>{
      const m = line.match(/\[(\d+):(\d+)(?:\.(\d+))?\](.*)/);
      if(m){ const t= (+m[1]*60)+(+m[2]) + ((+m[3]||0)/100);
        out.push({t, text:m[4].trim()}); }
      else if(line.trim()) out.push({t:NaN, text:line.trim()});
    });
    out.sort((a,b)=> (isNaN(a.t)?1:a.t)-(isNaN(b.t)?1:b.t));
    return out;
  }
  function renderKara(){
    const box=$('#karaoke'); box.innerHTML='';
    if(!lrc.length){ box.textContent='Lyric/Karaoke s·∫Ω hi·ªán ·ªü ƒë√¢y‚Ä¶'; return; }
    lrc.forEach((ln,i)=>{
      const p=document.createElement('div'); p.textContent=ln.text||' '; p.className='kline'+(i===activeIdx?' active':'');
      box.appendChild(p);
    });
    // auto scroll
    if(activeIdx>=0){
      const el = box.children[activeIdx];
      if(el) box.scrollTop = el.offsetTop - box.clientHeight/2 + 40;
    }
  }
  function tickKara(current){
    if(!lrc.length) return;
    // find last line with t<=current
    let i = activeIdx;
    while(i+1<lrc.length && !isNaN(lrc[i+1].t) && lrc[i+1].t<=current) i++;
    if(i!==activeIdx){ activeIdx=i; renderKara(); }
  }
  $('#lrcIn').addEventListener('change', async (e)=>{
    const f=e.target.files[0]; if(!f) return;
    const txt=await f.text(); lrc=parseLRC(txt); activeIdx=-1; renderKara();
    e.target.value='';
  });
  $('#btnPaste').onclick = ()=>{
    const txt = prompt('D√°n lyric ho·∫∑c LRC (c√≥ d·∫°ng [mm:ss.xx] c√¢u h√°t):'); 
    if(txt){ lrc=parseLRC(txt); activeIdx=-1; renderKara(); }
  };
  $('#btnKClear').onclick=()=>{ lrc=[]; activeIdx=-1; renderKara(); };

  // ---------- Record (MediaRecorder) ----------
  let rec, chunks=[];
  $('#btnRec').onclick = async ()=>{
    if(rec && rec.state==='recording'){ rec.stop(); return; }
    try{
      const stream = await navigator.mediaDevices.getUserMedia({audio:true});
      rec = new MediaRecorder(stream);
      chunks=[]; rec.ondataavailable=e=>chunks.push(e.data);
      rec.onstop=()=>{
        const blob = new Blob(chunks,{type:'audio/webm'});
        const file = new File([blob], 'record_'+Date.now()+'.webm', {type:'audio/webm'});
        const url = URL.createObjectURL(file);
        const id = Math.random().toString(36).slice(2);
        tracks.unshift({id,name:file.name,type:file.type,size:file.size,blobUrl:url,ext:'webm'});
        renderList(); playById(tracks[0].id);
        alert('ƒê√£ thu √¢m xong v√† th√™m v√†o playlist!');
      };
      rec.start(); alert('ƒêang ghi √¢m‚Ä¶ Nh·∫•n l·∫°i ‚ÄúRecord‚Äù ƒë·ªÉ d·ª´ng.');
    }catch(err){ alert('Kh√¥ng th·ªÉ truy c·∫≠p micro: '+err); }
  };

  // ---------- AI Song DEMO ----------
  // 1) From TEXT: chuy·ªÉn text th√†nh d√£y n·ªët simple v√† render ra WAV
  $('#btnAitext').onclick = async ()=>{
    const txt = prompt('Nh·∫≠p c√¢u m√¥ t·∫£ mood/lyrics (AI demo s·∫Ω t·∫°o giai ƒëi·ªáu 30s):','robot love pop bright');
    if(!txt) return;
    const audioBuf = await synthFromText(txt, 30); // 30s
    const wav = toWav(audioBuf, ctx.sampleRate);
    const blob = new Blob([wav], {type:'audio/wav'});
    const url = URL.createObjectURL(blob);
    const id = Math.random().toString(36).slice(2);
    tracks.unshift({id,name:'AI-'+txt.replace(/\s+/g,'_')+'.wav',type:'audio/wav',size:blob.size,blobUrl:url,ext:'wav'});
    renderList(); playById(tracks[0].id);
  };
  // 2) From IMAGE: l·∫•y t·ªïng m√†u ‚Üí t·∫°o tempo + thang √¢m
  $('#imgIn').addEventListener('change', async (e)=>{
    const f=e.target.files[0]; if(!f) return;
    const img=await createImageBitmap(f);
    // L·∫•y m√†u trung b√¨nh
    const c=document.createElement('canvas'); c.width=32;c.height=32;
    const g=c.getContext('2d'); g.drawImage(img,0,0,32,32);
    const d=g.getImageData(0,0,32,32).data; let r=0,gc=0,b=0;
    for(let i=0;i<d.length;i+=4){ r+=d[i]; gc+=d[i+1]; b+=d[i+2]; }
    r/=256; gc/=256; b/=256;
    const mood = (r>gc&&r>b)?'warm':(b>r&&b>gc?'cool':'neutral');
    const audioBuf = await synthFromText('image '+mood, 25);
    const wav = toWav(audioBuf, ctx.sampleRate);
    const blob = new Blob([wav], {type:'audio/wav'}); const url=URL.createObjectURL(blob);
    const id=Math.random().toString(36).slice(2);
    tracks.unshift({id,name:'AI_img_'+mood+'.wav',type:'audio/wav',size:blob.size,blobUrl:url,ext:'wav'});
    renderList(); playById(tracks[0].id);
    e.target.value='';
  });

  // Tiny synth: map text -> notes
  async function synthFromText(text, seconds=20){
    const sr = 44100, len = sr*seconds, buf = ctx.createBuffer(1,len,sr), ch=buf.getChannelData(0);
    // seed
    let seed = 0; for(let i=0;i<text.length;i++) seed=(seed*31 + text.charCodeAt(i))>>>0;
    function rnd(){ seed^=seed<<13; seed^=seed>>>17; seed^=seed<<5; return (seed>>>0)/0xffffffff; }
    const scales = [[0,2,4,7,9],[0,2,3,5,7,10],[0,3,5,7,10],[0,2,5,7,9]];
    const scale = scales[Math.floor(rnd()*scales.length)];
    const base = 220 + rnd()*110; // A3..D4
    let t=0; while(t<len){
      const noteDur = Math.floor(sr*(0.2 + rnd()*0.4));
      const freq = base * Math.pow(2, scale[Math.floor(rnd()*scale.length)]/12);
      for(let i=0;i<noteDur && t+i<len;i++){
        const v = Math.sin(2*Math.PI*freq*((t+i)/sr)) * (1 - i/noteDur); // simple env
        ch[t+i] += v*0.25;
      }
      t += noteDur;
    }
    // soft clip
    for(let i=0;i<len;i++){ ch[i]=Math.tanh(ch[i]*2.0); }
    return buf;
  }
  function toWav(buffer, sampleRate){
    // mono 16-bit PCM
    const samples = buffer.getChannelData(0);
    const blockAlign = 2, byteRate = sampleRate*blockAlign;
    const dataSize = samples.length*2;
    const buf = new ArrayBuffer(44+dataSize);
    const v = new DataView(buf);
    function wStr(o,s){ for(let i=0;i<s.length;i++) v.setUint8(o+i,s.charCodeAt(i)); }
    wStr(0,'RIFF'); v.setUint32(4,36+dataSize,true); wStr(8,'WAVE');
    wStr(12,'fmt '); v.setUint32(16,16,true); v.setUint16(20,1,true); v.setUint16(22,1,true);
    v.setUint32(24,sampleRate,true); v.setUint32(28,byteRate,true); v.setUint16(32,blockAlign,true); v.setUint16(34,16,true);
    wStr(36,'data'); v.setUint32(40,dataSize,true);
    let o=44; for(let i=0;i<samples.length;i++){ let s=Math.max(-1,Math.min(1,samples[i])); v.setInt16(o, s<0?s*0x8000:s*0x7FFF, true); o+=2; }
    return buf;
  }

  // ---------- Boot ----------
  renderList(); setTitle(); setCover();
})();
</script>

<!-- (t√πy ch·ªçn) n·∫øu ƒëang d√πng thanh n·ªïi chung: <script src="goc-ui.js?v=10" defer></script> -->

<script>
(function(){
  // L·∫•y tham chi·∫øu audio/video ch√≠nh c·ªßa ph√≤ng (ƒë·∫∑t id="player" cho ph·∫ßn t·ª≠ ph√°t)
  const player = document.getElementById('player') || document.querySelector('audio,video');

  // Th√¥ng tin b√†i ƒëang ph√°t -> s·ª≠a theo bi·∫øn th·ª±c t·∫ø trong trang c·ªßa G·ªëc
  function currentTrack(){
    // v√≠ d·ª• ƒë·ªçc t·ª´ dataset; ho·∫∑c bi·∫øn to√†n c·ª•c window.nowTrack
    const nt = (window.nowTrack)||{};
    return {
      title: nt.title || document.querySelector('.now-title')?.textContent || 'Unknown',
      artist: nt.artist || document.querySelector('.now-artist')?.textContent || '',
      cover: nt.cover || '',
      url: nt.src || (player?player.currentSrc:''),
      playing: !!(player && !player.paused)
    };
  }

  const bc = ('BroadcastChannel' in window) ? new BroadcastChannel('goc-music') : null;

  function broadcastNP(){
    const np = currentTrack();
    bc && bc.postMessage({type:'np', ...np});
    try{ localStorage.setItem('goc.music.now', JSON.stringify(np)); }catch(e){}
  }
  function broadcastState(){
    bc && bc.postMessage({type:'state', paused: player?.paused});
  }

  if(player){
    ['loadedmetadata','play','pause','ended'].forEach(ev=>{
      player.addEventListener(ev, ()=>{ broadcastNP(); broadcastState(); }, {passive:true});
    });
  }

  // Nh·∫≠n l·ªánh t·ª´ Mini-Player tr√™n thanh n·ªïi
  bc && bc.addEventListener('message', (e)=>{
    const m = e.data||{};
    if(!player) return;
    if(m.cmd==='toggle'){
      if(player.paused) player.play().catch(()=>{});
      else player.pause();
    }
    if(m.cmd==='next' && typeof window.nextTrack==='function'){ window.nextTrack(); }
    if(m.cmd==='prev' && typeof window.prevTrack==='function'){ window.prevTrack(); }
  });

  // kh·ªüi ph√°t l·∫ßn ƒë·∫ßu (n·∫øu c√≥ b√†i)
  setTimeout(broadcastNP, 200);
})();
</script>
<script src="goc-ui.js?v=18" defer></script>
<!-- ==== LICENSE G·ªêC ‚Ä¢ Upload Box (drop-in) ==== -->
<style>
  .goc-uibox{margin:14px 0;padding:12px;border:1px solid rgba(255,215,0,.22);
    border-radius:12px;background:linear-gradient(180deg,#0f1117,#0a0b0f)}
  .goc-uibox .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .goc-uibox button{appearance:none;border:1px solid rgba(245,211,106,.35);
    background:linear-gradient(180deg,#1a1f29,#0f1117);color:#eae7dc;
    border-radius:999px;padding:10px 14px;font-weight:700;cursor:pointer}
  .goc-drop{margin-top:10px;padding:14px;border:1px dashed rgba(255,215,0,.35);
    border-radius:10px;text-align:center;opacity:.8}
  .goc-drop.drag{background:#0d1118;border-style:solid;opacity:1}
  .goc-list{margin-top:12px;display:grid;gap:12px}
  .goc-item{display:grid;grid-template-columns:84px 1fr;gap:10px;align-items:center;
    padding:10px;border:1px solid rgba(255,215,0,.12);border-radius:12px}
  .goc-thumb{width:84px;height:64px;display:grid;place-items:center;
    background:#0d1118;border:1px solid rgba(255,255,255,.06);border-radius:10px;font-size:22px}
  .goc-meta{font-size:13px;opacity:.85}
</style>

<div class="goc-uibox" id="goc-uibox">
  <div class="row">
    <button id="goc-btn-upload">‚¨ÜÔ∏è Upload audio/video</button>
    <button id="goc-btn-clear" title="Clear current list">üßπ Clear list</button>
    <span id="goc-log" style="opacity:.7;font-size:12px"></span>
  </div>

  <div id="goc-drop" class="goc-drop">K√©o & th·∫£ t·ªáp v√†o ƒë√¢y, ho·∫∑c b·∫•m ‚ÄúUpload audio/video‚Äù</div>
  <input id="goc-input" type="file" accept="audio/*,video/*" multiple hidden>

  <div id="goc-list" class="goc-list"></div>
</div>

<script>
(function(){
  const $ = (s)=>document.querySelector(s);
  const btnUp   = $('#goc-btn-upload');
  const btnClr  = $('#goc-btn-clear');
  const finput  = $('#goc-input');
  const drop    = $('#goc-drop');
  const list    = $('#goc-list');
  const logEl   = $('#goc-log');

  function log(msg){ logEl.textContent = msg||''; }

  btnUp?.addEventListener('click', ()=>finput.click());
  finput?.addEventListener('change', (e)=> handleFiles(e.target.files));

  // Drag & drop
  ['dragenter','dragover'].forEach(ev=>{
    drop.addEventListener(ev, (e)=>{ e.preventDefault(); e.stopPropagation(); drop.classList.add('drag'); });
  });
  ['dragleave','drop'].forEach(ev=>{
    drop.addEventListener(ev, (e)=>{ e.preventDefault(); e.stopPropagation(); drop.classList.remove('drag'); });
  });
  drop.addEventListener('drop', (e)=>{ handleFiles(e.dataTransfer.files||[]); });

  // Clear list
  btnClr?.addEventListener('click', ()=>{
    list.innerHTML = ''; log('');
  });

  // Render one item
  function renderItem(file, url){
    const wrap = document.createElement('div');
    wrap.className = 'goc-item';

    const thumb = document.createElement('div');
    thumb.className = 'goc-thumb';
    thumb.textContent = file.type.startsWith('video') ? 'üé¨' : 'üéµ';

    const body = document.createElement('div');

    const title = document.createElement('div');
    title.style.fontWeight = '800';
    title.textContent = file.name;

    const meta = document.createElement('div');
    meta.className = 'goc-meta';
    meta.textContent = `${file.type || 'unknown'} ¬∑ ${(file.size/1024/1024).toFixed(2)}MB`;

    const player = document.createElement(file.type.startsWith('video') ? 'video' : 'audio');
    player.controls = true;
    player.preload = 'metadata';
    player.src = url;
    player.style.width = '100%';
    player.style.maxHeight = '280px';
    player.addEventListener('loadedmetadata', ()=>{
      // h·∫°n m·ª©c hi·ªÉn th·ªã th√¥ng tin th·ªùi l∆∞·ª£ng
      if (isFinite(player.duration)) {
        meta.textContent += ` ¬∑ ${formatTime(player.duration)}`;
      }
    });

    body.appendChild(title);
    body.appendChild(meta);
    body.appendChild(player);

    wrap.appendChild(thumb);
    wrap.appendChild(body);
    list.appendChild(wrap);
  }

  function formatTime(sec){
    sec = Math.round(sec||0);
    const h = Math.floor(sec/3600);
    const m = Math.floor((sec%3600)/60);
    const s = sec%60;
    return (h? (h+':') : '') + String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0');
  }

  // Main: handle files (10‚Äì20 ph√∫t ok n·∫øu dung l∆∞·ª£ng v·ª´a ph·∫£i)
  function handleFiles(files){
    if(!files || !files.length) return;
    [...files].forEach(f=>{
      if(!/^audio\/|^video\//.test(f.type)){ return; } // b·ªè qua lo·∫°i kh√¥ng h·ªó tr·ª£
      // Gi·ªõi h·∫°n dung l∆∞·ª£ng m·ªÅm: 500MB ƒë·ªÉ tr√°nh tr√†n RAM tr√¨nh duy·ªát
      const MB = f.size/1024/1024;
      if(MB>500){ log(`‚ö†Ô∏è ${f.name} qu√° l·ªõn (${MB.toFixed(1)}MB). H√£y ch·ªçn file < 500MB.`); return; }
      const url = URL.createObjectURL(f);
      renderItem(f, url);
    });
    log('T·ªáp ph√°t tr·ª±c ti·∫øp tr√™n tr√¨nh duy·ªát; kh√¥ng l∆∞u vƒ©nh vi·ªÖn.');
  }
})();
// ===== Music Room Config (t·ªëi ∆∞u cho file d√†i) =====
const GOC_MAX_MB = 500;              // ~500MB
const GOC_ACCEPT = 'audio/*,video/*';
const GOC_PREVIEW_THUMB = true;      // t·∫°o poster nhanh cho video (kh√¥ng b·∫Øt bu·ªôc)
</script>
</body>
</html>
